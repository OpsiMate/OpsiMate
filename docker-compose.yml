version: "3.8"

services:
  # Optional: LocalStack for S3 storage (profile images)
  # Remove this service if using real AWS S3
  localstack:
    image: localstack/localstack:latest
    container_name: opsimate-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=us-east-1
      - PERSISTENCE=1
      # CORS configuration for browser uploads
      - EXTRA_CORS_ALLOWED_ORIGINS=*
      - EXTRA_CORS_ALLOWED_HEADERS=*
      - EXTRA_CORS_EXPOSE_HEADERS=ETag
    volumes:
      - localstack-data:/var/lib/localstack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: opsimate/backend:latest
    container_name: opsimate-backend
    ports:
      - "3001:3001"        
    volumes:
      - ./data/database:/app/data/database
      - ./data/private-keys:/app/data/private-keys
      - ./config.yml:/app/config/config.yml
    environment:
      - API_TOKEN=opsimate
      - NODE_ENV=production
      - HOST=0.0.0.0
      - CONFIG_FILE=/app/config/config.yml
      # S3 Storage for profile images (connects to LocalStack)
      # To use real AWS S3: remove S3_ENDPOINT, S3_PUBLIC_ENDPOINT, and S3_FORCE_PATH_STYLE
      - S3_ENABLED=true
      - S3_BUCKET=opsimate-avatars
      - S3_REGION=us-east-1
      - S3_ENDPOINT=http://localstack:4566
      - S3_PUBLIC_ENDPOINT=http://localhost:4566
      - S3_FORCE_PATH_STYLE=true
      - S3_ACCESS_KEY_ID=test
      - S3_SECRET_ACCESS_KEY=test
    restart: unless-stopped
    depends_on:
      localstack:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: opsimate/backend:latest
    container_name: opsimate-worker
    command: ["node", "apps/server/dist/worker.js"]
    volumes:
      - ./data/database:/app/data/database
      - ./data/private-keys:/app/data/private-keys
      - ./config.yml:/app/config/config.yml
    environment:
      - NODE_ENV=production
      - CONFIG_FILE=/app/config/config.yml
    restart: unless-stopped

  frontend:
    image: opsimate/frontend:latest
    container_name: opsimate-frontend
    ports:
      - "8080:8080"        
    environment:
      - NODE_ENV=production
      - API_URL=http://backend:3001   
      - HOST=0.0.0.0
    restart: unless-stopped

volumes:
  localstack-data:
